---
title: "GSEA_RII"
author: "Weihan Liu and Stephanie Konecki"
date: "11/11/2019"
output: html_document
---

```{r setup, include=FALSE}
#this tells R when we render our code to print the lines of code as well as the result
knitr::opts_chunk$set(echo = TRUE)
```

*install Packages*
```{r}
#install the needed packages
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("fgsea")
```


*Load required libraries*
```{r}
#load the needed libraries 
library(tidyverse)
library(ggplot2)
library(fgsea)
library(DESeq2)

```


*Read in the results table generated by DeSeq2*
```{r}
library(tidyverse)
RII_DE_result <- read.csv("/Users/stephaniekonecki/Documents/grad\ school/Data/2019/October/SNK015/RII_DE_low\ vs\ ren.csv",stringsAsFactors = FALSE)
colnames(RII_DE_result) <- c("mouse_name","baseMean","log2FoldChange","lfcSE","stat","pvalue","padj")
head(RII_DE_result)
```


*Rank all genes based on their fold change for RII*
```{r}
#rank genes based on log2fold change
ranks_RII <- RII_DE_result$log2FoldChange
names(ranks_RII) <- RII_DE_result$gene
head(ranks_RII)

#plot the rank fold change
barplot(sort(ranks_RII,decreasing = T),,axisnames = FALSE)
```


*Parse results table so you only have gene symbol and statistic* 
```{r}
GSEA_RII <- RII_DE_result %>% 
  dplyr::select(mouse_name, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(mouse_name) %>% 
  summarize(stat=mean(stat))
head(GSEA_RII)
```
 
  
*convert mouse gene names to human gene names*
```{r}
m_to_h <- read.csv("/Users/stephaniekonecki/Desktop/mouseGeneIDtoHumanSymbol.csv")
colnames(m_to_h) <- c("ID", "mouse_name","human_name")
human_GSEA_RII <- inner_join(GSEA_RII,m_to_h,by = "mouse_name")
human_GSEA_RII <- human_GSEA_RII[,c(2,4)] #keep only the stat and human gene names
human_GSEA_RII<- na.omit(human_GSEA_RII,human_name) #remove all "na" genes
human_GSEA_RII <- human_GSEA_RII[, c("human_name", "stat")] #flips the columns around
colnames(human_GSEA_RII) <- c("gene", "stat")
human_GSEA_RII <- human_GSEA_RII %>% dplyr::arrange(desc(stat))
head(human_GSEA_RII) 


```



We’re going to use the fgsea package for fast preranked gene set enrichment analysis (GSEA).
The fgsea() function requires a list of gene sets to check, and a named vector of gene-level statistics, where the names should be the same as the gene names in the pathways list. First, let’s create our named vector of test statistics. See  ?tibble::deframe for help here - deframe() converts two-column data frames to a named vector or list, using the first column as name and the second column as value.


*create dataframe that GSEA likes* 
```{r}
ranks_RII <- deframe(human_GSEA_RII)
head(ranks_RII, 20)
```

Let’s use the Hallmark gene set from MSigDB. Hallmark gene sets summarize and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDB collections and retaining genes that display coordinate expression. The gmtPathways() function will take a GMT file you downloaded from MSigDB and turn it into a list. Each element in the list is a character vector of genes in the pathway.

*Generate a gene set*
```{r}
#first, download the pathway from GSEA online to your computer 
pathways.genesets<- gmtPathways("/Users/stephaniekonecki/Documents/grad\ school/Code/2019/SNK015/GSEA\ RII/genesets.gmt")  #Load the pathways into a named list

# Show the first few pathways, and within those, show  the first few genes. 
pathways.genesets %>% 
  head() %>% 
  lapply(head)
```


*compare your data to the geneset*
```{r}
library(DT)

GSEA_results_RII <- fgsea(pathways=pathways.genesets, stats=ranks_RII, nperm=1000)
#this compares the hallmark pathway, via the stats in our RII experiment, 1000 times

#Tidy the results:
tidy_GSEA_results_RII <- GSEA_results_RII %>%
  as_tibble() %>%
  dplyr::arrange(desc(NES))

# Show in a nice table:
tidy_GSEA_results_RII %>% 
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>% 
  dplyr::arrange(padj) %>% 
  DT::datatable()
# if you run this in terminal you can save this table as a website to go back to in the future
```

*generate the enrichment score plot for one pathway*
```{r}
#plot the enrichment score for a pathway of interest
plotEnrichment(pathways.hallmark[["HALLMARK_HEME_METABOLISM"]], ranks_RII)
```







*Plot the normalized enrichment score for all the pathways* 
```{r}
#the bars are colored based on signifance 
ggplot(tidy_GSEA_results_RII, aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill=padj<0.1)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title="GO pathways NES from GSEA") + 
  theme_minimal() +
        theme(axis.text.y=element_text(size=6, face = "bold"))
```
