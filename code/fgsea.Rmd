---
title: "GSEA_RII"
author: "Weihan Liu"
date: "28/08/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("fgsea")
```


Load required libraries
```{r}
library(tidyverse)
library(ggplot2)
library(fgsea)

```


```{r}
# musGenes <- c("Hmmr", "Tlx3", "Cpeb4")
#  
# # Basic function to convert mouse to human gene names
# convertMouseGeneList <- function(x){
#  
# require("biomaRt")
# human = useMart("ensembl", dataset = "hsapiens_gene_ensembl")
# mouse = useMart("ensembl", dataset = "mmusculus_gene_ensembl")
#  
# genesV2 = getLDS(attributes = c("mgi_symbol"), filters = "mgi_symbol", values = x , mart = mouse, attributesL = c("hgnc_symbol"), martL = human, uniqueRows=T)
# humanx <- unique(genesV2[, 2])
#  
# # Print the first 6 genes found to the screen
# print(head(humanx))
# return(humanx)
# }

```


#Read in the result table from DeSeq2
```{r}
library(tidyverse)
res_RII <- read.csv("/Users/weihan/Desktop/Research/Bulk_RNA_seq/SNK015_SK_WL/Deseq2_output/RII_DE_result.csv",stringsAsFactors = FALSE)
res_MEP <- read.csv("/Users/weihan/Desktop/Research/Bulk_RNA_seq/SNK015_SK_WL/Deseq2_output/MEP_DE_result.csv", stringsAsFactors = FALSE)
res_RII
res_MEP
colnames(res_RII) <- c("gene","baseMean","log2FoldChange","lfcSE","stat","pvalue","padj")
colnames(res_MEP) <- c("gene","baseMean","log2FoldChange","lfcSE","stat","pvalue","padj")
head(res_RII)
head(res_MEP)
```

#Create Ranks

Rank all genes based on their fold change for MEP
```{r}
#construct gene ranking table by their log2foldchange calue
ranks_MEP <- res_MEP$log2FoldChange
names(ranks_MEP) <- res_MEP$gene
head(ranks_MEP)

#plot the rank fold change
barplot(sort(ranks_MEP,decreasing = T),,axisnames = FALSE)
```

Rank all genes based on their fold change for RII
```{r}
#construct gene ranking table by their log2foldchange calue
ranks_RII <- res_RII$log2FoldChange
names(ranks_RII) <- res_RII$gene
head(ranks_RII)

#plot the rank fold change
barplot(sort(ranks_RII,decreasing = T),,axisnames = FALSE)
```





All you’ll care about later on is the gene symbol and the test statistic. Get just those, and remove the NAs.
Do it for RII
```{r}
res_RII2 <- res_RII %>% 
  dplyr::select(gene, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(gene) %>% 
  summarize(stat=mean(stat))
head(res_RII2)
 
  
#read in megan's mouse to human gene name conversion table
m_to_h <- read_table2("/Users/weihan/Desktop/Research/Bulk_RNA_seq/mouseGeneIDtoHumanSymbol_2018.txt")
colnames(m_to_h) <- c("gene","human_gene")
res_RII2 <- inner_join(res_RII2,m_to_h,by = "gene")
res_RII2 <- res_RII2[c(3,2,1)]
res_RII2 <- res_RII2[,c(1,2)]


res_RII2 <- na.omit(res_RII2,human_gene) 
colnames(res_RII2) <- c("gene","stat")
res_RII2 <- res_RII2 %>% dplyr::arrange(desc(stat))
head(res_RII2) 


```



Do it for MEP
```{r}
res_MEP2 <- res_MEP %>% 
  dplyr::select(gene, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(gene) %>% 
  summarize(stat=mean(stat))
head(res_MEP2)
 
  
#read in megan's mouse to human gene name conversion table
m_to_h <- read_table2("/Users/weihan/Desktop/Research/Bulk_RNA_seq/mouseGeneIDtoHumanSymbol_2018.txt")
colnames(m_to_h) <- c("gene","human_gene")
res_MEP2 <- inner_join(res_MEP2,m_to_h,by = "gene")
res_MEP2 <- res_MEP2[c(3,2,1)]
res_MEP2 <- res_MEP2[,c(1,2)]


res_MEP2 <- na.omit(res_MEP2,human_gene) 
colnames(res_MEP2) <- c("gene","stat")
res_MEP2 <- res_MEP2 %>% dplyr::arrange(desc(stat))
head(res_MEP2) 


```






We’re going to use the fgsea package for fast preranked gene set enrichment analysis (GSEA).
The fgsea() function requires a list of gene sets to check, and a named vector of gene-level statistics, where the names should be the same as the gene names in the pathways list. First, let’s create our named vector of test statistics. See  ?tibble::deframe for help here - deframe() converts two-column data frames to a named vector or list, using the first column as name and the second column as value.
```{r}
ranks_RII <- deframe(res_RII2)
ranks_MEP <- deframe(res_MEP2)
head(ranks_RII, 20)
head(ranks_MEP, 20)
```

Let’s use the Hallmark gene set from MSigDB. Hallmark gene sets summarize and represent specific well-defined biological states or processes and display coherent expression. These gene sets were generated by a computational methodology based on identifying overlaps between gene sets in other MSigDB collections and retaining genes that display coordinate expression. The gmtPathways() function will take a GMT file you downloaded from MSigDB and turn it into a list. Each element in the list is a character vector of genes in the pathway.
```{r}
# Load the pathways into a named list
pathways.hallmark <- gmtPathways("/Users/weihan/Desktop/Research/Bulk_RNA_seq/SNK015_SK_WL/GSEA/h.all.v7.0.symbols.gmt")

# Look at them all if you want (uncomment)
pathways.hallmark

# Show the first few pathways, and within those, show only the first few genes. 
pathways.hallmark %>% 
  head() %>% 
  lapply(head)
```

Now, run the fgsea algorithm with 1000 permutations for RII
```{r}
library(DT)
#RII
fgseaRes_RII <- fgsea(pathways=pathways.hallmark, stats=ranks_RII, nperm=1000)
#Tidy the results:
fgseaResTidy_RII <- fgseaRes_RII %>%
  as_tibble() %>%
  dplyr::arrange(desc(NES))

# Show in a nice table:
fgseaResTidy_RII %>% 
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>% 
  dplyr::arrange(padj) %>% 
  DT::datatable()

```

Now, run the fgsea algorithm with 1000 permutations for MEP
```{r}
library(DT)
#RII
fgseaRes_MEP <- fgsea(pathways=pathways.hallmark, stats=ranks_MEP, nperm=1000)
#Tidy the results:
fgseaResTidy_MEP <- fgseaRes_MEP %>%
  as_tibble() %>%
  dplyr::arrange(desc(NES))

# Show in a nice table:
fgseaResTidy_MEP %>% 
  dplyr::select(-leadingEdge, -ES, -nMoreExtreme) %>% 
  dplyr::arrange(padj) %>% 
  DT::datatable()

```


Enrichment Score plot
MEP
```{r}
#plot the enrichment score for all pathways of interest
plotEnrichment(pathways.hallmark[["HALLMARK_APICAL_JUNCTION"]], ranks_MEP)
```







For RII, Plot the normalized enrichment scores. Color the bar indicating whether or not the pathway was significant:
```{r}
ggplot(fgseaResTidy_RII, aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill=padj<0.1)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title="Hallmark pathways NES from GSEA") + 
  theme_minimal() +
        theme(axis.text.y=element_text(size=6, face = "bold"))
```


For MEP, Plot the normalized enrichment scores. Color the bar indicating whether or not the pathway was significant:
```{r}
ggplot(fgseaResTidy_MEP, aes(reorder(pathway, NES), NES)) +
  geom_col(aes(fill=padj<0.1)) +
  coord_flip() +
  labs(x="Pathway", y="Normalized Enrichment Score",
       title="Hallmark pathways NES from GSEA") + 
  theme_minimal() +
        theme(axis.text.y=element_text(size=6, face = "bold"))
```
